<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Regional Sales Designer Dashboard - Canada Region</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            box-sizing: border-box;
        }
        .gradient-header {
            background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
        }
        .card {
            transition: all 0.3s ease;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .progress-bar {
            height: 8px;
            border-radius: 4px;
            background-color: #e2e8f0;
            overflow: hidden;
        }
        .progress {
            height: 100%;
            border-radius: 4px;
            transition: width 1s ease-in-out;
        }
        .franchise-card {
            border-left: 4px solid transparent;
            transition: all 0.3s ease;
        }
        .franchise-card.top-performer {
            border-left-color: #10b981;
            background: linear-gradient(135deg, #ecfdf5 0%, #f0fdf4 100%);
        }
        .franchise-card.needs-attention {
            border-left-color: #f59e0b;
            background: linear-gradient(135deg, #fffbeb 0%, #fefce8 100%);
        }
        .franchise-card.underperforming {
            border-left-color: #ef4444;
            background: linear-gradient(135deg, #fef2f2 0%, #fefefe 100%);
        }
        .rank-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            font-weight: bold;
            font-size: 14px;
        }
        .rank-1 { background: linear-gradient(135deg, #ffd700, #ffed4e); color: #92400e; }
        .rank-2 { background: linear-gradient(135deg, #c0c0c0, #e5e7eb); color: #374151; }
        .rank-3 { background: linear-gradient(135deg, #cd7f32, #d97706); color: white; }
        .rank-other { background: #f3f4f6; color: #6b7280; }
        .sync-indicator {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .analytics-view {
            transition: all 0.3s ease;
        }
        .designer-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            color: white;
        }
        .performance-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-left: 4px;
        }
        .trending-up { background-color: #10b981; }
        .trending-down { background-color: #ef4444; }
        .trending-stable { background-color: #f59e0b; }
        .table-header {
            position: sticky;
            top: 0;
            z-index: 10;
        }
    </style>
</head>
<body>
    <div class="min-h-screen">
        <!-- Header -->
        <header class="gradient-header text-white p-6 shadow-lg">
            <div class="container mx-auto flex flex-col md:flex-row justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold">Regional Sales Designer Dashboard</h1>
                    <p class="text-purple-100">Canada Region • 5 Franchise Locations</p>
                </div>
                <div class="mt-4 md:mt-0 flex items-center space-x-4">
                    <div id="lastSyncStatus" class="flex items-center px-3 py-1 rounded-full bg-white bg-opacity-20">
                        <div id="syncIndicator" class="w-2 h-2 rounded-full bg-green-400 mr-2"></div>
                        <span id="syncText" class="text-sm text-white">All franchises synced</span>
                    </div>
                    <div class="relative">
                        <select id="timeframe" class="bg-white bg-opacity-20 text-white rounded-lg px-4 py-2 appearance-none focus:outline-none focus:ring-2 focus:ring-white">
                            <option value="week">This Week</option>
                            <option value="month" selected>This Month</option>
                            <option value="ytd">Year to Date</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-white">
                            <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                                <path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/>
                            </svg>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button id="regionalSettings" class="bg-white bg-opacity-20 text-white font-medium py-2 px-4 rounded-lg hover:bg-opacity-30 transition-colors">
                            Settings
                        </button>
                        <button id="exportRegionalData" class="bg-white bg-opacity-20 text-white font-medium py-2 px-4 rounded-lg hover:bg-opacity-30 transition-colors">
                            Export All
                        </button>
                        <button id="addFranchise" class="bg-white text-purple-700 font-medium py-2 px-4 rounded-lg hover:bg-purple-50 transition-colors">
                            Add Franchise
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="container mx-auto p-6">
            <!-- Regional Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-6 mb-8">
                <div class="card bg-white rounded-xl shadow p-6">
                    <h3 class="text-gray-500 text-sm font-medium" id="totalSalesTitle">Regional Sales</h3>
                    <p class="text-3xl font-bold text-gray-800" id="totalRegionalSales">$0</p>
                    <div class="mt-2 flex items-center">
                        <span class="text-green-500 text-sm font-medium flex items-center">
                            <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12 7a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0V8.414l-4.293 4.293a1 1 0 01-1.414 0L8 10.414l-4.293 4.293a1 1 0 01-1.414-1.414l5-5a1 1 0 011.414 0L11 10.586l3.293-3.293A1 1 0 0114 7z" clip-rule="evenodd"/>
                            </svg>
                            <span id="regionalGrowth">0%</span>
                        </span>
                        <span class="text-gray-500 text-sm ml-2" id="growthComparisonText">vs last period</span>
                    </div>
                </div>
                <div class="card bg-white rounded-xl shadow p-6">
                    <h3 class="text-gray-500 text-sm font-medium">Total Designers</h3>
                    <p class="text-3xl font-bold text-gray-800" id="totalDesigners">0</p>
                    <p class="text-gray-500 text-sm mt-2" id="avgDesignersPerFranchise">0 avg per franchise</p>
                </div>
                <div class="card bg-white rounded-xl shadow p-6">
                    <h3 class="text-gray-500 text-sm font-medium">Avg Closing Rate</h3>
                    <p class="text-3xl font-bold text-gray-800" id="regionalClosingRate">0%</p>
                    <div class="mt-2 flex items-center">
                        <span class="text-blue-500 text-sm font-medium" id="closingRateTrend">0%</span>
                        <span class="text-gray-500 text-sm ml-2">vs target</span>
                    </div>
                </div>
                <div class="card bg-white rounded-xl shadow p-6">
                    <h3 class="text-gray-500 text-sm font-medium">Top Franchise</h3>
                    <p class="text-2xl font-bold text-gray-800" id="topFranchiseName">---</p>
                    <p class="text-gray-500 text-sm mt-2" id="topFranchiseSales">$0</p>
                </div>
                <div class="card bg-white rounded-xl shadow p-6">
                    <h3 class="text-gray-500 text-sm font-medium">Goal Progress</h3>
                    <p class="text-3xl font-bold text-gray-800" id="regionalGoalProgress">0%</p>
                    <div class="mt-2 progress-bar">
                        <div class="progress bg-purple-600" id="regionalGoalBar" style="width: 0%"></div>
                    </div>
                    <p class="text-gray-500 text-sm mt-2" id="goalProgressText">$0 of $0</p>
                </div>
                <div class="card bg-white rounded-xl shadow p-6">
                    <h3 class="text-gray-500 text-sm font-medium">Active Franchises</h3>
                    <p class="text-3xl font-bold text-gray-800" id="activeFranchises">0</p>
                    <div class="mt-2 flex items-center">
                        <div class="w-2 h-2 rounded-full bg-green-400 mr-2"></div>
                        <span class="text-gray-500 text-sm" id="franchiseStatus">All online</span>
                    </div>
                </div>
            </div>

            <!-- Regional Top Performers -->
            <div class="bg-white rounded-xl shadow overflow-hidden mb-8">
                <div class="p-6 border-b border-gray-200">
                    <h2 class="text-xl font-bold text-gray-800 flex items-center">
                        <svg class="w-6 h-6 mr-2 text-yellow-500" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                        </svg>
                        Regional Top Performers
                    </h2>
                </div>
                <div class="p-6" id="regionalTopPerformers">
                    <!-- Top performers will be populated by JavaScript -->
                </div>
            </div>

            <!-- Franchisee Rankings -->
            <div class="bg-white rounded-xl shadow overflow-hidden mb-8">
                <div class="p-6 border-b border-gray-200">
                    <h2 class="text-xl font-bold text-gray-800 flex items-center">
                        <svg class="w-6 h-6 mr-2 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        Franchisee Rankings
                    </h2>
                </div>
                <div class="p-6" id="franchiseeRankings">
                    <!-- Franchisee rankings will be populated by JavaScript -->
                </div>
            </div>

            <!-- Franchise Performance Overview -->
            <div class="bg-white rounded-xl shadow overflow-hidden mb-8">
                <div class="p-6 border-b border-gray-200">
                    <div class="flex justify-between items-center">
                        <h2 class="text-xl font-bold text-gray-800">Franchise Performance Overview</h2>
                        <div class="flex items-center space-x-4">
                            <div class="relative">
                                <input type="text" id="searchFranchise" placeholder="Search franchises..." class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                                <div class="absolute left-3 top-2.5 text-gray-400">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                    </svg>
                                </div>
                            </div>
                            <select id="sortBy" class="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="sales">Sort by Sales</option>
                                <option value="goal">Sort by Goal Progress</option>
                                <option value="closing">Sort by Closing Rate</option>
                                <option value="designers">Sort by Designer Count</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="p-6">
                    <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6" id="franchiseCards">
                        <!-- Franchise cards will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Regional Designer Leaderboard -->
            <div class="bg-white rounded-xl shadow overflow-hidden">
                <div class="p-6 border-b border-gray-200">
                    <div class="flex justify-between items-center">
                        <h2 class="text-xl font-bold text-gray-800">Regional Designer Leaderboard</h2>
                        <div class="flex items-center space-x-4">
                            <div class="relative">
                                <input type="text" id="searchDesigner" placeholder="Search designers..." class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                                <div class="absolute left-3 top-2.5 text-gray-400">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                    </svg>
                                </div>
                            </div>
                            <select id="leaderboardFilter" class="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="sales">Top by Sales</option>
                                <option value="avgTicket">Top by Avg Ticket</option>
                                <option value="closingRate">Top by Closing Rate</option>
                                <option value="goalProgress">Top by Goal Progress</option>
                            </select>
                            <div class="flex items-center text-sm text-gray-500">
                                <div class="w-2 h-2 rounded-full bg-purple-400 mr-2"></div>
                                <span id="leaderboardDescription">Top Regional Performers</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50 table-header">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rank</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Designer</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Franchise</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider" id="designerSalesHeader">Period Sales</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Avg. Ticket</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Closing Rate</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Goal Progress</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Trend</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="designerLeaderboard">
                            <!-- Designer rows will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Franchise Details Modal -->
    <div id="franchiseModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800" id="franchiseModalTitle">Franchise Details</h3>
                <button id="closeFranchiseModal" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div id="franchiseModalContent">
                <!-- Franchise details will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Add Franchise Modal -->
    <div id="addFranchiseModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">Add New Franchise</h3>
                <button id="closeAddFranchiseModal" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <form id="addFranchiseForm">
                <div class="mb-4">
                    <label for="newFranchiseName" class="block text-sm font-medium text-gray-700 mb-1">Franchise Name</label>
                    <input type="text" id="newFranchiseName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500" required>
                </div>
                <div class="mb-4">
                    <label for="newFranchiseeName" class="block text-sm font-medium text-gray-700 mb-1">Franchisee Name</label>
                    <input type="text" id="newFranchiseeName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500" required>
                </div>
                <div class="mb-4">
                    <label for="newFranchiseLocation" class="block text-sm font-medium text-gray-700 mb-1">Location</label>
                    <input type="text" id="newFranchiseLocation" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500" required>
                </div>
                <div class="mb-4">
                    <label for="newFranchiseGoal" class="block text-sm font-medium text-gray-700 mb-1">Monthly Goal ($)</label>
                    <input type="number" id="newFranchiseGoal" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500" required>
                </div>
                <div class="flex justify-end">
                    <button type="button" id="cancelAddFranchise" class="mr-2 px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">Cancel</button>
                    <button type="submit" class="px-4 py-2 text-white bg-purple-600 rounded-lg hover:bg-purple-700 transition-colors">Add Franchise</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Franchise Modal -->
    <div id="editFranchiseModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">Edit Franchise</h3>
                <button id="closeEditFranchiseModal" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <form id="editFranchiseForm">
                <div class="mb-4">
                    <label for="editFranchiseName" class="block text-sm font-medium text-gray-700 mb-1">Franchise Name</label>
                    <input type="text" id="editFranchiseName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500" required>
                </div>
                <div class="mb-4">
                    <label for="editFranchiseeName" class="block text-sm font-medium text-gray-700 mb-1">Franchisee Name</label>
                    <input type="text" id="editFranchiseeName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500" required>
                </div>
                <div class="mb-4">
                    <label for="editFranchiseLocation" class="block text-sm font-medium text-gray-700 mb-1">Location</label>
                    <input type="text" id="editFranchiseLocation" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500" required>
                </div>
                <div class="mb-4">
                    <label for="editFranchiseGoal" class="block text-sm font-medium text-gray-700 mb-1">Monthly Goal ($)</label>
                    <input type="number" id="editFranchiseGoal" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500" required>
                </div>
                <div class="mb-4">
                    <label for="editFranchiseStatus" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                    <select id="editFranchiseStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                        <option value="online">Online</option>
                        <option value="offline">Offline</option>
                        <option value="maintenance">Maintenance</option>
                    </select>
                </div>
                <div class="flex justify-between">
                    <button type="button" id="deleteFranchise" class="px-4 py-2 text-white bg-red-600 rounded-lg hover:bg-red-700 transition-colors">Delete</button>
                    <div class="flex space-x-2">
                        <button type="button" id="cancelEditFranchise" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">Cancel</button>
                        <button type="submit" class="px-4 py-2 text-white bg-purple-600 rounded-lg hover:bg-purple-700 transition-colors">Save Changes</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Regional Configuration
        const REGIONAL_CONFIG = {
            regionId: 'canada_region',
            regionName: 'Canada Region',
            storageKey: 'regional_dashboard_data',
            autoSyncInterval: 45000, // 45 seconds
            maxRetries: 3
        };

        // Regional Data Manager Class
        class RegionalDataManager {
            constructor() {
                this.regionalData = this.loadRegionalData();
                this.currentTimeframe = 'month';
                this.setupEventListeners();
                this.startAutoSync();
            }

            loadRegionalData() {
                try {
                    const stored = localStorage.getItem(REGIONAL_CONFIG.storageKey);
                    if (stored) {
                        return JSON.parse(stored);
                    }
                } catch (error) {
                    console.warn('Failed to load regional data:', error);
                }
                return this.generateSampleRegionalData();
            }

            generateSampleRegionalData() {
                return {
                    regionInfo: {
                        id: REGIONAL_CONFIG.regionId,
                        name: REGIONAL_CONFIG.regionName,
                        totalFranchises: 5
                    },
                    franchises: [
                        {
                            id: 'franchise_001',
                            name: 'Downtown Location',
                            franchiseeName: 'Sarah Johnson', // Franchisee name
                            location: 'New York, NY',
                            monthlyGoal: 200000,
                            coordinates: { x: 60, y: 45 },
                            status: 'online',
                            lastSync: new Date().toISOString(),
                            designers: [
                                {
                                    id: 1,
                                    name: "Emma Johnson",
                                    monthlySales: 42500,
                                    weeklySales: 12800,
                                    appointments: 15,
                                    sales: 8,
                                    monthlyGoal: 50000,
                                    franchiseId: 'franchise_001',
                                    franchiseName: 'Downtown Location',
                                    trend: 'up'
                                },
                                {
                                    id: 2,
                                    name: "Michael Chen",
                                    monthlySales: 38700,
                                    weeklySales: 9500,
                                    appointments: 12,
                                    sales: 7,
                                    monthlyGoal: 45000,
                                    franchiseId: 'franchise_001',
                                    franchiseName: 'Downtown Location',
                                    trend: 'up'
                                },
                                {
                                    id: 3,
                                    name: "Sophia Rodriguez",
                                    monthlySales: 29800,
                                    weeklySales: 11200,
                                    appointments: 14,
                                    sales: 6,
                                    monthlyGoal: 40000,
                                    franchiseId: 'franchise_001',
                                    franchiseName: 'Downtown Location',
                                    trend: 'stable'
                                },
                                {
                                    id: 4,
                                    name: "James Wilson",
                                    monthlySales: 13500,
                                    weeklySales: 9300,
                                    appointments: 10,
                                    sales: 4,
                                    monthlyGoal: 24000,
                                    franchiseId: 'franchise_001',
                                    franchiseName: 'Downtown Location',
                                    trend: 'down'
                                }
                            ]
                        },
                        {
                            id: 'franchise_002',
                            name: 'Westside Gallery',
                            franchiseeName: 'Michael Chen',
                            location: 'Los Angeles, CA',
                            monthlyGoal: 180000,
                            coordinates: { x: 25, y: 65 },
                            status: 'online',
                            lastSync: new Date(Date.now() - 300000).toISOString(),
                            designers: [
                                {
                                    id: 5,
                                    name: "Isabella Garcia",
                                    monthlySales: 48200,
                                    weeklySales: 14500,
                                    appointments: 18,
                                    sales: 12,
                                    monthlyGoal: 55000,
                                    franchiseId: 'franchise_002',
                                    franchiseName: 'Westside Gallery',
                                    trend: 'up'
                                },
                                {
                                    id: 6,
                                    name: "Victoria Chen",
                                    monthlySales: 41300,
                                    weeklySales: 11800,
                                    appointments: 16,
                                    sales: 9,
                                    monthlyGoal: 48000,
                                    franchiseId: 'franchise_002',
                                    franchiseName: 'Westside Gallery',
                                    trend: 'up'
                                },
                                {
                                    id: 7,
                                    name: "David Park",
                                    monthlySales: 35600,
                                    weeklySales: 10200,
                                    appointments: 13,
                                    sales: 8,
                                    monthlyGoal: 42000,
                                    franchiseId: 'franchise_002',
                                    franchiseName: 'Westside Gallery',
                                    trend: 'stable'
                                }
                            ]
                        },
                        {
                            id: 'franchise_003',
                            name: 'Magnificent Mile',
                            franchiseeName: 'David Rodriguez',
                            location: 'Chicago, IL',
                            monthlyGoal: 220000,
                            coordinates: { x: 45, y: 55 },
                            status: 'online',
                            lastSync: new Date(Date.now() - 120000).toISOString(),
                            designers: [
                                {
                                    id: 8,
                                    name: "William Brown",
                                    monthlySales: 41800,
                                    weeklySales: 13200,
                                    appointments: 17,
                                    sales: 10,
                                    monthlyGoal: 50000,
                                    franchiseId: 'franchise_003',
                                    franchiseName: 'Magnificent Mile',
                                    trend: 'up'
                                },
                                {
                                    id: 9,
                                    name: "Alexander Stone",
                                    monthlySales: 39400,
                                    weeklySales: 12100,
                                    appointments: 14,
                                    sales: 8,
                                    monthlyGoal: 46000,
                                    franchiseId: 'franchise_003',
                                    franchiseName: 'Magnificent Mile',
                                    trend: 'stable'
                                },
                                {
                                    id: 10,
                                    name: "Rachel Kim",
                                    monthlySales: 33200,
                                    weeklySales: 9800,
                                    appointments: 12,
                                    sales: 7,
                                    monthlyGoal: 38000,
                                    franchiseId: 'franchise_003',
                                    franchiseName: 'Magnificent Mile',
                                    trend: 'up'
                                },
                                {
                                    id: 11,
                                    name: "Thomas Lee",
                                    monthlySales: 28900,
                                    weeklySales: 8700,
                                    appointments: 11,
                                    sales: 6,
                                    monthlyGoal: 35000,
                                    franchiseId: 'franchise_003',
                                    franchiseName: 'Magnificent Mile',
                                    trend: 'down'
                                }
                            ]
                        },
                        {
                            id: 'franchise_004',
                            name: 'Pike Place Studio',
                            franchiseeName: 'Emily Thompson',
                            location: 'Seattle, WA',
                            monthlyGoal: 160000,
                            coordinates: { x: 15, y: 35 },
                            status: 'online',
                            lastSync: new Date(Date.now() - 600000).toISOString(),
                            designers: [
                                {
                                    id: 12,
                                    name: "Sarah Kim",
                                    monthlySales: 37800,
                                    weeklySales: 11400,
                                    appointments: 14,
                                    sales: 11,
                                    monthlyGoal: 44000,
                                    franchiseId: 'franchise_004',
                                    franchiseName: 'Pike Place Studio',
                                    trend: 'up'
                                },
                                {
                                    id: 13,
                                    name: "Kevin Martinez",
                                    monthlySales: 31500,
                                    weeklySales: 9200,
                                    appointments: 12,
                                    sales: 7,
                                    monthlyGoal: 36000,
                                    franchiseId: 'franchise_004',
                                    franchiseName: 'Pike Place Studio',
                                    trend: 'stable'
                                },
                                {
                                    id: 14,
                                    name: "Amanda Foster",
                                    monthlySales: 26700,
                                    weeklySales: 8100,
                                    appointments: 10,
                                    sales: 6,
                                    monthlyGoal: 32000,
                                    franchiseId: 'franchise_004',
                                    franchiseName: 'Pike Place Studio',
                                    trend: 'down'
                                }
                            ]
                        },
                        {
                            id: 'franchise_005',
                            name: 'Ocean Drive',
                            franchiseeName: 'Carlos Martinez',
                            location: 'Miami, FL',
                            monthlyGoal: 190000,
                            coordinates: { x: 70, y: 80 },
                            status: 'online',
                            lastSync: new Date(Date.now() - 180000).toISOString(),
                            designers: [
                                {
                                    id: 15,
                                    name: "Marcus Davis",
                                    monthlySales: 44100,
                                    weeklySales: 13600,
                                    appointments: 16,
                                    sales: 11,
                                    monthlyGoal: 52000,
                                    franchiseId: 'franchise_005',
                                    franchiseName: 'Ocean Drive',
                                    trend: 'up'
                                },
                                {
                                    id: 16,
                                    name: "Jennifer Lopez",
                                    monthlySales: 36900,
                                    weeklySales: 10800,
                                    appointments: 13,
                                    sales: 8,
                                    monthlyGoal: 43000,
                                    franchiseId: 'franchise_005',
                                    franchiseName: 'Ocean Drive',
                                    trend: 'stable'
                                },
                                {
                                    id: 17,
                                    name: "Carlos Rodriguez",
                                    monthlySales: 32400,
                                    weeklySales: 9700,
                                    appointments: 12,
                                    sales: 7,
                                    monthlyGoal: 38000,
                                    franchiseId: 'franchise_005',
                                    franchiseName: 'Ocean Drive',
                                    trend: 'up'
                                },
                                {
                                    id: 18,
                                    name: "Lisa Wang",
                                    monthlySales: 24800,
                                    weeklySales: 7400,
                                    appointments: 9,
                                    sales: 5,
                                    monthlyGoal: 30000,
                                    franchiseId: 'franchise_005',
                                    franchiseName: 'Ocean Drive',
                                    trend: 'down'
                                }
                            ]
                        }
                    ],
                    lastUpdated: new Date().toISOString(),
                    version: '1.0.0'
                };
            }

            saveRegionalData() {
                try {
                    localStorage.setItem(REGIONAL_CONFIG.storageKey, JSON.stringify(this.regionalData));
                } catch (error) {
                    console.error('Failed to save regional data:', error);
                }
            }

            getAllDesigners() {
                return this.regionalData.franchises.flatMap(franchise => 
                    franchise.designers.map(designer => ({
                        ...designer,
                        franchiseLocation: franchise.location
                    }))
                );
            }

            getFranchiseMetrics(franchise) {
                const timeframeData = this.getTimeframeData(franchise.designers);
                const totalSales = timeframeData.reduce((sum, d) => sum + d.sales, 0);
                const totalGoal = timeframeData.reduce((sum, d) => sum + d.goal, 0);
                const totalAppointments = timeframeData.reduce((sum, d) => sum + d.appointments, 0);
                const totalSalesCount = timeframeData.reduce((sum, d) => sum + d.salesCount, 0);

                return {
                    totalSales,
                    totalGoal,
                    goalProgress: totalGoal > 0 ? (totalSales / totalGoal) * 100 : 0,
                    avgClosingRate: totalAppointments > 0 ? (totalSalesCount / totalAppointments) * 100 : 0,
                    designerCount: franchise.designers.length,
                    avgSalesPerDesigner: franchise.designers.length > 0 ? totalSales / franchise.designers.length : 0
                };
            }

            getRegionalMetrics() {
                const allDesigners = this.getAllDesigners();
                const timeframeData = this.getTimeframeData(allDesigners);
                
                const totalSales = timeframeData.reduce((sum, d) => sum + d.sales, 0);
                const totalGoal = timeframeData.reduce((sum, d) => sum + d.goal, 0);
                const totalAppointments = timeframeData.reduce((sum, d) => sum + d.appointments, 0);
                const totalSalesCount = timeframeData.reduce((sum, d) => sum + d.salesCount, 0);

                return {
                    totalSales,
                    totalGoal,
                    goalProgress: totalGoal > 0 ? (totalSales / totalGoal) * 100 : 0,
                    avgClosingRate: totalAppointments > 0 ? (totalSalesCount / totalAppointments) * 100 : 0,
                    totalDesigners: allDesigners.length,
                    avgDesignersPerFranchise: this.regionalData.franchises.length > 0 ? allDesigners.length / this.regionalData.franchises.length : 0,
                    activeFranchises: this.regionalData.franchises.filter(f => f.status === 'online').length,
                    timeframe: this.currentTimeframe
                };
            }

            getTimeframeData(designers) {
                return designers.map(designer => {
                    switch (this.currentTimeframe) {
                        case 'week':
                            return {
                                ...designer,
                                sales: designer.weeklySales,
                                goal: designer.monthlyGoal / 4.33,
                                appointments: Math.round(designer.appointments / 4.33),
                                salesCount: Math.round(designer.sales / 4.33)
                            };
                        case 'ytd':
                            const monthsInYear = new Date().getMonth() + 1;
                            return {
                                ...designer,
                                sales: designer.monthlySales * monthsInYear,
                                goal: designer.monthlyGoal * 12,
                                appointments: designer.appointments * monthsInYear,
                                salesCount: designer.sales * monthsInYear
                            };
                        case 'month':
                        default:
                            return {
                                ...designer,
                                sales: designer.monthlySales,
                                goal: designer.monthlyGoal,
                                appointments: designer.appointments,
                                salesCount: designer.sales
                            };
                    }
                });
            }

            setTimeframe(timeframe) {
                this.currentTimeframe = timeframe;
            }

            getTimeframeLabel() {
                switch (this.currentTimeframe) {
                    case 'week':
                        return 'This Week';
                    case 'ytd':
                        return 'Year to Date';
                    case 'month':
                    default:
                        return 'This Month';
                }
            }

            addFranchise(franchiseData) {
                const newFranchise = {
                    id: `franchise_${Date.now()}`,
                    ...franchiseData,
                    coordinates: this.generateRandomCoordinates(),
                    status: 'online',
                    lastSync: new Date().toISOString(),
                    designers: []
                };
                
                this.regionalData.franchises.push(newFranchise);
                this.regionalData.regionInfo.totalFranchises = this.regionalData.franchises.length;
                this.saveRegionalData();
                
                return newFranchise;
            }

            updateFranchise(franchiseId, updateData) {
                const franchiseIndex = this.regionalData.franchises.findIndex(f => f.id === franchiseId);
                if (franchiseIndex === -1) return null;

                this.regionalData.franchises[franchiseIndex] = {
                    ...this.regionalData.franchises[franchiseIndex],
                    ...updateData,
                    lastSync: new Date().toISOString()
                };

                this.saveRegionalData();
                
                // Push changes to Version 12 if bidirectional sync is enabled
                if (CONNECTION_CONFIG.bidirectionalSync) {
                    this.pushToVersion12(franchiseId);
                }
                
                return this.regionalData.franchises[franchiseIndex];
            }

            deleteFranchise(franchiseId) {
                const franchiseIndex = this.regionalData.franchises.findIndex(f => f.id === franchiseId);
                if (franchiseIndex === -1) return false;

                this.regionalData.franchises.splice(franchiseIndex, 1);
                this.regionalData.regionInfo.totalFranchises = this.regionalData.franchises.length;
                this.saveRegionalData();
                
                return true;
            }

            getFranchiseById(franchiseId) {
                return this.regionalData.franchises.find(f => f.id === franchiseId);
            }

            generateRandomCoordinates() {
                return {
                    x: Math.random() * 80 + 10, // 10-90% of container width
                    y: Math.random() * 60 + 20  // 20-80% of container height
                };
            }

            setupEventListeners() {
                // Auto-sync simulation
            }

            startAutoSync() {
                setInterval(() => {
                    // Simulate receiving updates from franchises
                    this.simulateFranchiseUpdates();
                }, REGIONAL_CONFIG.autoSyncInterval);
            }

            simulateFranchiseUpdates() {
                // Randomly update some designer data to simulate real-time sync
                this.regionalData.franchises.forEach(franchise => {
                    if (Math.random() > 0.7) { // 30% chance of update per franchise
                        franchise.lastSync = new Date().toISOString();
                        
                        franchise.designers.forEach(designer => {
                            if (Math.random() > 0.8) { // 20% chance per designer
                                const variation = (Math.random() - 0.5) * 0.1; // ±5% variation
                                designer.weeklySales = Math.max(0, designer.weeklySales * (1 + variation));
                            }
                        });
                    }
                });
                
                this.saveRegionalData();
            }

            exportAllData() {
                const regionalMetrics = this.getRegionalMetrics();
                const exportData = {
                    regionInfo: this.regionalData.regionInfo,
                    regionalMetrics,
                    franchises: this.regionalData.franchises.map(franchise => ({
                        ...franchise,
                        metrics: this.getFranchiseMetrics(franchise)
                    })),
                    allDesigners: this.getAllDesigners(),
                    exportedAt: new Date().toISOString()
                };

                return JSON.stringify(exportData, null, 2);
            }

            showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${this.getNotificationClass(type)}`;
                notification.textContent = message;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 5000);
            }

            getNotificationClass(type) {
                const classes = {
                    success: 'bg-green-500 text-white',
                    error: 'bg-red-500 text-white',
                    warning: 'bg-yellow-500 text-black',
                    info: 'bg-purple-500 text-white'
                };
                return classes[type] || classes.info;
            }
        }

        // Initialize Regional Data Manager
        const regionalDataManager = new RegionalDataManager();

        // Format currency
        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        };

        // Render regional summary
        const renderRegionalSummary = () => {
            const metrics = regionalDataManager.getRegionalMetrics();
            const timeframeLabel = regionalDataManager.getTimeframeLabel();

            document.getElementById('totalSalesTitle').textContent = `Regional ${timeframeLabel} Sales`;
            document.getElementById('totalRegionalSales').textContent = formatCurrency(metrics.totalSales);
            document.getElementById('totalDesigners').textContent = metrics.totalDesigners;
            document.getElementById('avgDesignersPerFranchise').textContent = `${metrics.avgDesignersPerFranchise.toFixed(1)} avg per franchise`;
            document.getElementById('regionalClosingRate').textContent = `${metrics.avgClosingRate.toFixed(1)}%`;
            document.getElementById('regionalGoalProgress').textContent = `${metrics.goalProgress.toFixed(1)}%`;
            document.getElementById('regionalGoalBar').style.width = `${Math.min(metrics.goalProgress, 100)}%`;
            document.getElementById('goalProgressText').textContent = 
                `${formatCurrency(metrics.totalSales)} of ${formatCurrency(metrics.totalGoal)}`;
            document.getElementById('activeFranchises').textContent = metrics.activeFranchises;

            // Find top franchise
            const franchiseMetrics = regionalDataManager.regionalData.franchises.map(f => ({
                ...f,
                metrics: regionalDataManager.getFranchiseMetrics(f)
            }));
            const topFranchise = franchiseMetrics.sort((a, b) => b.metrics.totalSales - a.metrics.totalSales)[0];
            
            if (topFranchise) {
                document.getElementById('topFranchiseName').textContent = topFranchise.name;
                document.getElementById('topFranchiseSales').textContent = formatCurrency(topFranchise.metrics.totalSales);
            }

            // Simulate growth
            document.getElementById('regionalGrowth').textContent = '+12.3%';
            document.getElementById('closingRateTrend').textContent = '+2.1%';

            // Update comparison text
            const comparisonTexts = {
                'week': 'vs last week',
                'month': 'vs last month', 
                'ytd': 'vs last year'
            };
            document.getElementById('growthComparisonText').textContent = comparisonTexts[regionalDataManager.currentTimeframe];
        };



        // Render regional top performers
        const renderRegionalTopPerformers = () => {
            const allDesigners = regionalDataManager.getAllDesigners();
            const timeframeData = regionalDataManager.getTimeframeData(allDesigners);
            const sortedDesigners = timeframeData.sort((a, b) => b.sales - a.sales).slice(0, 5);
            
            const container = document.getElementById('regionalTopPerformers');
            container.innerHTML = '';

            sortedDesigners.forEach((designer, index) => {
                const avgTicket = designer.salesCount > 0 ? designer.sales / designer.salesCount : 0;
                const closingRate = designer.appointments > 0 ? (designer.salesCount / designer.appointments) * 100 : 0;
                
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between p-3 rounded-lg mb-3 hover:bg-gray-50 transition-colors';
                
                const rankClass = index < 3 ? `rank-${index + 1}` : 'rank-other';
                const medal = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : `#${index + 1}`;
                
                // Find the franchise to get franchisee name
                const franchise = regionalDataManager.regionalData.franchises.find(f => f.name === designer.franchiseName);
                const franchiseeName = franchise ? franchise.franchiseeName : 'Unknown Owner';
                
                item.innerHTML = `
                    <div class="flex items-center">
                        <div class="rank-badge ${rankClass} mr-3">
                            ${typeof medal === 'string' && medal.startsWith('#') ? medal.slice(1) : medal}
                        </div>
                        <div>
                            <div class="font-medium text-gray-900">${designer.name}</div>
                            <div class="text-sm text-gray-500">${designer.franchiseName}</div>
                            <div class="text-xs text-purple-600 font-medium">Owner: ${franchiseeName}</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-gray-900">${formatCurrency(designer.sales)}</div>
                        <div class="text-sm text-gray-500">${closingRate.toFixed(1)}% close</div>
                    </div>
                `;
                
                container.appendChild(item);
            });
        };

        // Render franchisee rankings
        const renderFranchiseeRankings = () => {
            const franchises = regionalDataManager.regionalData.franchises;
            const franchiseMetrics = franchises.map(f => ({
                ...f,
                metrics: regionalDataManager.getFranchiseMetrics(f)
            }));
            
            const sortedFranchisees = franchiseMetrics.sort((a, b) => b.metrics.totalSales - a.metrics.totalSales);
            
            const container = document.getElementById('franchiseeRankings');
            container.innerHTML = '';

            sortedFranchisees.forEach((franchise, index) => {
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between p-4 rounded-lg mb-3 hover:bg-gray-50 transition-colors border border-gray-100';
                
                const rankClass = index < 3 ? `rank-${index + 1}` : 'rank-other';
                const medal = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : `#${index + 1}`;
                
                item.innerHTML = `
                    <div class="flex items-center">
                        <div class="rank-badge ${rankClass} mr-4">
                            ${typeof medal === 'string' && medal.startsWith('#') ? medal.slice(1) : medal}
                        </div>
                        <div>
                            <div class="font-bold text-gray-900">${franchise.franchiseeName || 'Not Set'}</div>
                            <div class="text-sm text-gray-600">${franchise.name}</div>
                            <div class="text-xs text-gray-500">${franchise.location}</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-gray-900">${formatCurrency(franchise.metrics.totalSales)}</div>
                        <div class="text-sm text-gray-500">${franchise.metrics.goalProgress.toFixed(1)}% of goal</div>
                        <div class="text-xs text-gray-400">${franchise.metrics.designerCount} designers</div>
                    </div>
                `;
                
                container.appendChild(item);
            });
        };

        // Render franchise cards
        const renderFranchiseCards = (franchisesToRender = null) => {
            const franchises = franchisesToRender || regionalDataManager.regionalData.franchises;
            const container = document.getElementById('franchiseCards');
            container.innerHTML = '';

            franchises.forEach(franchise => {
                const metrics = regionalDataManager.getFranchiseMetrics(franchise);
                const card = document.createElement('div');
                
                let cardClass = 'franchise-card';
                if (metrics.goalProgress >= 110) cardClass += ' top-performer';
                else if (metrics.goalProgress < 70) cardClass += ' underperforming';
                else if (metrics.goalProgress < 90) cardClass += ' needs-attention';

                const syncStatus = new Date(franchise.lastSync);
                const timeSinceSync = Math.floor((Date.now() - syncStatus.getTime()) / 60000);
                const syncText = timeSinceSync < 5 ? 'Just synced' : `${timeSinceSync}m ago`;

                card.className = `${cardClass} card bg-white rounded-xl shadow p-6 cursor-pointer`;
                card.addEventListener('click', () => showFranchiseDetails(franchise.id));
                
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-lg font-bold text-gray-800">${franchise.name}</h3>
                            <p class="text-sm text-purple-600 font-medium">Owner: ${franchise.franchiseeName || 'Not Set'}</p>
                            <p class="text-sm text-gray-500">${franchise.location}</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button onclick="editFranchise('${franchise.id}')" class="text-purple-600 hover:text-purple-800 p-1 rounded" title="Edit Franchise">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                            </button>
                            <div class="flex items-center text-xs text-gray-400">
                                <div class="w-2 h-2 rounded-full ${franchise.status === 'online' ? 'bg-green-400' : 'bg-red-400'} mr-1"></div>
                                ${syncText}
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <p class="text-2xl font-bold text-gray-800">${formatCurrency(metrics.totalSales)}</p>
                            <p class="text-sm text-gray-500">Sales</p>
                        </div>
                        <div>
                            <p class="text-2xl font-bold text-gray-800">${metrics.designerCount}</p>
                            <p class="text-sm text-gray-500">Designers</p>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm text-gray-600">Goal Progress</span>
                            <span class="text-sm font-medium">${metrics.goalProgress.toFixed(1)}%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress ${metrics.goalProgress >= 100 ? 'bg-green-500' : metrics.goalProgress >= 75 ? 'bg-blue-500' : metrics.goalProgress >= 50 ? 'bg-yellow-500' : 'bg-red-500'}" 
                                style="width: ${Math.min(metrics.goalProgress, 100)}%"></div>
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-center text-sm">
                        <span class="text-gray-600">Avg Close Rate</span>
                        <span class="font-medium">${metrics.avgClosingRate.toFixed(1)}%</span>
                    </div>
                `;
                
                container.appendChild(card);
            });
        };

        // Render designer leaderboard
        const renderDesignerLeaderboard = (designersToRender = null, sortBy = 'sales') => {
            const allDesigners = designersToRender || regionalDataManager.getAllDesigners();
            const timeframeData = regionalDataManager.getTimeframeData(allDesigners);
            
            // Sort based on selected criteria
            const sortedDesigners = timeframeData.sort((a, b) => {
                const avgTicketA = a.salesCount > 0 ? a.sales / a.salesCount : 0;
                const avgTicketB = b.salesCount > 0 ? b.sales / b.salesCount : 0;
                const closingRateA = a.appointments > 0 ? (a.salesCount / a.appointments) * 100 : 0;
                const closingRateB = b.appointments > 0 ? (b.salesCount / b.appointments) * 100 : 0;
                const goalProgressA = (a.sales / a.goal) * 100;
                const goalProgressB = (b.sales / b.goal) * 100;
                
                switch (sortBy) {
                    case 'avgTicket':
                        return avgTicketB - avgTicketA;
                    case 'closingRate':
                        return closingRateB - closingRateA;
                    case 'goalProgress':
                        return goalProgressB - goalProgressA;
                    case 'sales':
                    default:
                        return b.sales - a.sales;
                }
            });
            
            const tbody = document.getElementById('designerLeaderboard');
            tbody.innerHTML = '';

            sortedDesigners.forEach((designer, index) => {
                const avgTicket = designer.salesCount > 0 ? designer.sales / designer.salesCount : 0;
                const closingRate = designer.appointments > 0 ? (designer.salesCount / designer.appointments) * 100 : 0;
                const goalProgress = (designer.sales / designer.goal) * 100;
                const rank = index + 1;
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                const rankClass = rank <= 3 ? `rank-${rank}` : 'rank-other';
                const isTop10 = rank <= 10;
                
                const trendIcon = designer.trend === 'up' ? '↗️' : designer.trend === 'down' ? '↘️' : '➡️';
                const trendClass = designer.trend === 'up' ? 'trending-up' : designer.trend === 'down' ? 'trending-down' : 'trending-stable';
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="rank-badge ${rankClass}">
                            ${rank}
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="designer-avatar bg-gradient-to-r from-purple-400 to-pink-400 mr-3">
                                ${designer.name.split(' ').map(n => n[0]).join('')}
                            </div>
                            <div>
                                <div class="text-sm font-medium text-gray-900 flex items-center">
                                    ${designer.name}
                                    ${isTop10 ? '<span class="ml-2 text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded-full">Top 10</span>' : ''}
                                </div>
                                <div class="text-xs text-gray-500">Regional Rank #${rank}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${designer.franchiseName}</div>
                        <div class="text-xs text-gray-500">${designer.franchiseLocation}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">${formatCurrency(designer.sales)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">${formatCurrency(avgTicket)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">${closingRate.toFixed(1)}%</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right">
                        <div class="flex items-center justify-end">
                            <div class="mr-2 w-16 progress-bar">
                                <div class="progress ${goalProgress >= 100 ? 'bg-green-500' : goalProgress >= 75 ? 'bg-purple-500' : goalProgress >= 50 ? 'bg-yellow-500' : 'bg-red-500'}" 
                                    style="width: ${Math.min(goalProgress, 100)}%"></div>
                            </div>
                            <span class="text-sm font-medium">${goalProgress.toFixed(1)}%</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right">
                        <div class="flex items-center justify-end">
                            <span class="text-lg mr-1">${trendIcon}</span>
                            <div class="performance-indicator ${trendClass}"></div>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        };

        // Show franchise details modal
        const showFranchiseDetails = (franchiseId) => {
            const franchise = regionalDataManager.regionalData.franchises.find(f => f.id === franchiseId);
            if (!franchise) return;

            const metrics = regionalDataManager.getFranchiseMetrics(franchise);
            const modal = document.getElementById('franchiseModal');
            const title = document.getElementById('franchiseModalTitle');
            const content = document.getElementById('franchiseModalContent');

            title.textContent = `${franchise.name} - Detailed View`;

            content.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h4 class="font-semibold text-gray-800 mb-2">Sales Performance</h4>
                        <p class="text-2xl font-bold text-gray-900">${formatCurrency(metrics.totalSales)}</p>
                        <p class="text-sm text-gray-500">Goal: ${formatCurrency(metrics.totalGoal)}</p>
                        <div class="mt-2 progress-bar">
                            <div class="progress bg-purple-600" style="width: ${Math.min(metrics.goalProgress, 100)}%"></div>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">${metrics.goalProgress.toFixed(1)}% of goal</p>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h4 class="font-semibold text-gray-800 mb-2">Team Performance</h4>
                        <p class="text-2xl font-bold text-gray-900">${metrics.designerCount}</p>
                        <p class="text-sm text-gray-500">Active Designers</p>
                        <p class="text-sm text-gray-600 mt-2">Avg Close Rate: ${metrics.avgClosingRate.toFixed(1)}%</p>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h4 class="font-semibold text-gray-800 mb-2">Franchise Info</h4>
                        <p class="text-sm text-gray-600">${franchise.location}</p>
                        <p class="text-sm text-gray-600">ID: ${franchise.id}</p>
                        <p class="text-xs text-gray-500 mt-2">Last sync: ${new Date(franchise.lastSync).toLocaleString()}</p>
                    </div>
                </div>

                <div class="bg-white border rounded-lg overflow-hidden">
                    <div class="bg-gray-50 px-4 py-3 border-b">
                        <h4 class="font-semibold text-gray-800">Designer Performance</h4>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Designer</th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Sales</th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Goal Progress</th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Close Rate</th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Trend</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                ${franchise.designers.map(designer => {
                                    const timeframeDesigner = regionalDataManager.getTimeframeData([designer])[0];
                                    const closingRate = timeframeDesigner.appointments > 0 ? (timeframeDesigner.salesCount / timeframeDesigner.appointments) * 100 : 0;
                                    const goalProgress = (timeframeDesigner.sales / timeframeDesigner.goal) * 100;
                                    const trendIcon = designer.trend === 'up' ? '📈' : designer.trend === 'down' ? '📉' : '➡️';
                                    
                                    return `
                                        <tr class="hover:bg-gray-50">
                                            <td class="px-4 py-3">
                                                <div class="flex items-center">
                                                    <div class="designer-avatar bg-gradient-to-r from-blue-400 to-purple-400 mr-3">
                                                        ${designer.name.split(' ').map(n => n[0]).join('')}
                                                    </div>
                                                    <span class="font-medium text-gray-900">${designer.name}</span>
                                                </div>
                                            </td>
                                            <td class="px-4 py-3 text-right font-medium">${formatCurrency(timeframeDesigner.sales)}</td>
                                            <td class="px-4 py-3 text-right">
                                                <div class="flex items-center justify-end">
                                                    <div class="w-12 progress-bar mr-2">
                                                        <div class="progress ${goalProgress >= 100 ? 'bg-green-500' : 'bg-blue-500'}" style="width: ${Math.min(goalProgress, 100)}%"></div>
                                                    </div>
                                                    <span class="text-sm">${goalProgress.toFixed(1)}%</span>
                                                </div>
                                            </td>
                                            <td class="px-4 py-3 text-right">${closingRate.toFixed(1)}%</td>
                                            <td class="px-4 py-3 text-right text-lg">${trendIcon}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            modal.classList.remove('hidden');
        };

        // Search functionality
        const setupSearch = () => {
            const franchiseSearch = document.getElementById('searchFranchise');
            const designerSearch = document.getElementById('searchDesigner');

            franchiseSearch.addEventListener('input', () => {
                const searchTerm = franchiseSearch.value.toLowerCase();
                const filteredFranchises = regionalDataManager.regionalData.franchises.filter(f => 
                    f.name.toLowerCase().includes(searchTerm) || 
                    f.location.toLowerCase().includes(searchTerm)
                );
                renderFranchiseCards(filteredFranchises);
            });

            designerSearch.addEventListener('input', () => {
                const searchTerm = designerSearch.value.toLowerCase();
                const allDesigners = regionalDataManager.getAllDesigners();
                const filteredDesigners = allDesigners.filter(d => 
                    d.name.toLowerCase().includes(searchTerm) || 
                    d.franchiseName.toLowerCase().includes(searchTerm)
                );
                const currentFilter = document.getElementById('leaderboardFilter').value;
                renderDesignerLeaderboard(filteredDesigners, currentFilter);
            });
        };

        // Leaderboard filter functionality
        const setupLeaderboardFilter = () => {
            const leaderboardFilter = document.getElementById('leaderboardFilter');
            const leaderboardDescription = document.getElementById('leaderboardDescription');
            
            const filterDescriptions = {
                'sales': 'Top Regional Performers by Sales',
                'avgTicket': 'Top Regional Performers by Average Ticket',
                'closingRate': 'Top Regional Performers by Closing Rate',
                'goalProgress': 'Top Regional Performers by Goal Progress'
            };
            
            leaderboardFilter.addEventListener('change', () => {
                const filterValue = leaderboardFilter.value;
                leaderboardDescription.textContent = filterDescriptions[filterValue];
                
                // Apply current search filter if any
                const searchTerm = document.getElementById('searchDesigner').value.toLowerCase();
                let designersToRender = regionalDataManager.getAllDesigners();
                
                if (searchTerm) {
                    designersToRender = designersToRender.filter(d => 
                        d.name.toLowerCase().includes(searchTerm) || 
                        d.franchiseName.toLowerCase().includes(searchTerm)
                    );
                }
                
                renderDesignerLeaderboard(designersToRender, filterValue);
            });
        };

        // Sort functionality
        const setupSort = () => {
            const sortSelect = document.getElementById('sortBy');
            
            sortSelect.addEventListener('change', () => {
                const sortBy = sortSelect.value;
                const franchises = [...regionalDataManager.regionalData.franchises];
                
                franchises.sort((a, b) => {
                    const metricsA = regionalDataManager.getFranchiseMetrics(a);
                    const metricsB = regionalDataManager.getFranchiseMetrics(b);
                    
                    switch (sortBy) {
                        case 'sales':
                            return metricsB.totalSales - metricsA.totalSales;
                        case 'goal':
                            return metricsB.goalProgress - metricsA.goalProgress;
                        case 'closing':
                            return metricsB.avgClosingRate - metricsA.avgClosingRate;
                        case 'designers':
                            return metricsB.designerCount - metricsA.designerCount;
                        default:
                            return 0;
                    }
                });
                
                renderFranchiseCards(franchises);
            });
        };

        // Modal functions
        const setupModals = () => {
            const franchiseModal = document.getElementById('franchiseModal');
            const closeFranchiseModal = document.getElementById('closeFranchiseModal');
            const addFranchiseModal = document.getElementById('addFranchiseModal');
            const addFranchiseBtn = document.getElementById('addFranchise');
            const closeAddFranchiseModal = document.getElementById('closeAddFranchiseModal');
            const cancelAddFranchise = document.getElementById('cancelAddFranchise');
            const addFranchiseForm = document.getElementById('addFranchiseForm');

            // Edit franchise modal elements
            const editFranchiseModal = document.getElementById('editFranchiseModal');
            const closeEditFranchiseModal = document.getElementById('closeEditFranchiseModal');
            const cancelEditFranchise = document.getElementById('cancelEditFranchise');
            const editFranchiseForm = document.getElementById('editFranchiseForm');
            const deleteFranchiseBtn = document.getElementById('deleteFranchise');

            closeFranchiseModal.addEventListener('click', () => {
                franchiseModal.classList.add('hidden');
            });

            addFranchiseBtn.addEventListener('click', () => {
                addFranchiseModal.classList.remove('hidden');
            });

            closeAddFranchiseModal.addEventListener('click', () => {
                addFranchiseModal.classList.add('hidden');
            });

            cancelAddFranchise.addEventListener('click', () => {
                addFranchiseModal.classList.add('hidden');
            });

            closeEditFranchiseModal.addEventListener('click', () => {
                editFranchiseModal.classList.add('hidden');
            });

            cancelEditFranchise.addEventListener('click', () => {
                editFranchiseModal.classList.add('hidden');
            });

            addFranchiseForm.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const name = document.getElementById('newFranchiseName').value;
                const franchiseeName = document.getElementById('newFranchiseeName').value;
                const location = document.getElementById('newFranchiseLocation').value;
                const monthlyGoal = parseFloat(document.getElementById('newFranchiseGoal').value);
                
                regionalDataManager.addFranchise({ name, franchiseeName, location, monthlyGoal });
                regionalDataManager.showNotification('Franchise added successfully', 'success');
                
                addFranchiseModal.classList.add('hidden');
                addFranchiseForm.reset();
                renderAll();
            });

            editFranchiseForm.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const franchiseId = editFranchiseForm.dataset.franchiseId;
                const name = document.getElementById('editFranchiseName').value;
                const franchiseeName = document.getElementById('editFranchiseeName').value;
                const location = document.getElementById('editFranchiseLocation').value;
                const monthlyGoal = parseFloat(document.getElementById('editFranchiseGoal').value);
                const status = document.getElementById('editFranchiseStatus').value;
                
                regionalDataManager.updateFranchise(franchiseId, { name, franchiseeName, location, monthlyGoal, status });
                regionalDataManager.showNotification('Franchise updated successfully', 'success');
                
                editFranchiseModal.classList.add('hidden');
                renderAll();
            });

            deleteFranchiseBtn.addEventListener('click', () => {
                const franchiseId = editFranchiseForm.dataset.franchiseId;
                const franchise = regionalDataManager.getFranchiseById(franchiseId);
                
                if (confirm(`Are you sure you want to delete "${franchise.name}"? This action cannot be undone.`)) {
                    regionalDataManager.deleteFranchise(franchiseId);
                    regionalDataManager.showNotification('Franchise deleted successfully', 'success');
                    
                    editFranchiseModal.classList.add('hidden');
                    renderAll();
                }
            });
        };

        // Timeframe change handler
        const setupTimeframe = () => {
            const timeframeSelect = document.getElementById('timeframe');
            
            timeframeSelect.addEventListener('change', (e) => {
                regionalDataManager.setTimeframe(e.target.value);
                
                // Update table header
                const headerTexts = {
                    'week': 'Weekly Sales',
                    'month': 'Monthly Sales',
                    'ytd': 'YTD Sales'
                };
                document.getElementById('designerSalesHeader').textContent = headerTexts[e.target.value];
                
                renderAll();
            });
        };

        // Setup analytics view switching
        const setupAnalyticsView = () => {
            const analyticsViewSelect = document.getElementById('analyticsView');
            
            analyticsViewSelect.addEventListener('change', () => {
                renderPerformanceAnalytics();
            });
        };

        // Export functionality
        const setupExport = () => {
            const exportBtn = document.getElementById('exportRegionalData');
            
            exportBtn.addEventListener('click', () => {
                const data = regionalDataManager.exportAllData();
                const filename = `regional_dashboard_${new Date().toISOString().split('T')[0]}.json`;
                
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                regionalDataManager.showNotification('Regional data exported successfully', 'success');
            });
        };

        // Render all components
        const renderAll = () => {
            renderRegionalSummary();
            renderRegionalTopPerformers();
            renderFranchiseeRankings();
            renderFranchiseCards();
            renderDesignerLeaderboard();
        };

        // Edit franchise function (global scope for onclick)
        window.editFranchise = (franchiseId) => {
            const franchise = regionalDataManager.getFranchiseById(franchiseId);
            if (!franchise) return;

            const editModal = document.getElementById('editFranchiseModal');
            const editForm = document.getElementById('editFranchiseForm');
            
            // Populate form fields
            document.getElementById('editFranchiseName').value = franchise.name;
            document.getElementById('editFranchiseeName').value = franchise.franchiseeName || '';
            document.getElementById('editFranchiseLocation').value = franchise.location;
            document.getElementById('editFranchiseGoal').value = franchise.monthlyGoal;
            document.getElementById('editFranchiseStatus').value = franchise.status;
            
            // Store franchise ID in form dataset
            editForm.dataset.franchiseId = franchiseId;
            
            // Show modal
            editModal.classList.remove('hidden');
        };

        // Setup Version 12 sync functionality
        const setupVersion12Sync = () => {
            const syncBtn = document.getElementById('syncVersion12');
            
            syncBtn.addEventListener('click', () => {
                const hasUpdates = regionalDataManager.manualSyncVersion12();
                if (hasUpdates) {
                    renderAll(); // Re-render all components with updated data
                }
            });
            
            // Check initial connection status
            const checkInitialConnection = () => {
                const version12Data = localStorage.getItem(CONNECTION_CONFIG.franchiseDashboardKey);
                if (version12Data) {
                    regionalDataManager.updateConnectionStatus('connected');
                } else {
                    regionalDataManager.updateConnectionStatus('disconnected');
                }
            };
            
            checkInitialConnection();
        };

        // Initialize everything
        setupSearch();
        setupSort();
        setupLeaderboardFilter();
        setupModals();
        setupTimeframe();
        setupAnalyticsView();
        setupExport();
        setupVersion12Sync();
        renderAll();

        // Initial notification
        setTimeout(() => {
            regionalDataManager.showNotification('Regional dashboard loaded successfully', 'success');
        }, 1000);
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'985f4fb35397985c',t:'MTc1OTAyMTMwNC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
